
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "influxdb.fullname" . }}
  labels:
    app: {{ template "influxdb.fullname" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
data:
  influxdb.conf: |+
    reporting-disabled = {{ .Values.influxdb.config.reporting_disabled | default false }}
    bind-address = ":{{ .Values.influxdb.config.rpc.bind_address }}"

    [meta]
      dir = "{{ .Values.influxdb.config.storage_directory }}/meta"
      retention-autocreate = {{ .Values.influxdb.config.meta.retention_autocreate }}
      logging-enabled = {{ .Values.influxdb.config.meta.logging_enabled }}

    [data]
      dir = "{{ .Values.influxdb.config.storage_directory }}/data"
      wal-dir = "{{ .Values.influxdb.config.storage_directory }}/wal"
      query-log-enabled = {{ .Values.influxdb.config.data.query_log_enabled }}
      cache-max-memory-size = {{ .Values.influxdb.config.data.cache_max_memory_size | int64 }}
      cache-snapshot-memory-size = {{ .Values.influxdb.config.data.cache_snapshot_memory_size | int64 }}
      cache-snapshot-write-cold-duration = "{{ .Values.influxdb.config.data.cache_snapshot_write_cold_duration }}"
      compact-full-write-cold-duration = "{{ .Values.influxdb.config.data.compact_full_write_cold_duration }}"
      max-series-per-database = {{ .Values.influxdb.config.data.max_series_per_database | int64 }}
      max-values-per-tag = {{ .Values.influxdb.config.data.max_values_per_tag | int64 }}
      trace-logging-enabled = {{ .Values.influxdb.config.data.trace_logging_enabled }}

    [coordinator]
      write-timeout = "{{ .Values.influxdb.config.coordinator.write_timeout }}"
      max-concurrent-queries = {{ .Values.influxdb.config.coordinator.max_concurrent_queries | int64 }}
      query-timeout = "{{ .Values.influxdb.config.coordinator.query_timeout }}"
      log-queries-after = "{{ .Values.influxdb.config.coordinator.log_queries_after }}"
      max-select-point = {{ .Values.influxdb.config.coordinator.max_select_point | int64 }}
      max-select-series = {{ .Values.influxdb.config.coordinator.max_select_series | int64 }}
      max-select-buckets = {{ .Values.influxdb.config.coordinator.max_select_buckets | int64 }}

    [retention]
      enabled = {{ .Values.influxdb.config.retention.enabled }}
      check-interval = "{{ .Values.influxdb.config.retention.check_interval }}"

    [shard-precreation]
      enabled = {{ .Values.influxdb.config.shard_precreation.enabled }}
      check-interval = "{{ .Values.influxdb.config.shard_precreation.check_interval }}"
      advance-period = "{{ .Values.influxdb.config.shard_precreation.advance_period }}"

    [admin]
      enabled = {{ .Values.influxdb.config.admin.enabled }}
      bind-address = ":{{ .Values.influxdb.config.admin.bind_address }}"
      https-enabled = {{ .Values.influxdb.config.admin.https_enabled }}
      https-certificate = "{{ .Values.influxdb.config.admin.https_certificate }}"

    [monitor]
      store-enabled = {{ .Values.influxdb.config.monitor.store_enabled }}
      store-database = "{{ .Values.influxdb.config.monitor.store_database }}"
      store-interval = "{{ .Values.influxdb.config.monitor.store_interval }}"

    [subscriber]
      enabled = {{ .Values.influxdb.config.subscriber.enabled }}
      http-timeout = "{{ .Values.influxdb.config.subscriber.http_timeout }}"
      insecure-skip-verify = {{ .Values.influxdb.config.subscriber.insecure_skip_verify }}
      ca-certs = "{{ .Values.influxdb.config.subscriber.ca_certs }}"
      write-concurrency = {{ .Values.influxdb.config.subscriber.write_concurrency | int64 }}
      write-buffer-size = {{ .Values.influxdb.config.subscriber.write_buffer_size | int64 }}

    [http]
      enabled = {{ .Values.influxdb.config.http.enabled }}
      bind-address = ":{{ .Values.influxdb.config.http.bind_address }}"
      auth-enabled = {{ .Values.influxdb.config.http.auth_enabled }}
      log-enabled = {{ .Values.influxdb.config.http.log_enabled }}
      write-tracing = {{ .Values.influxdb.config.http.write_tracing }}
      pprof-enabled = {{ .Values.influxdb.config.http.pprof_enabled }}
      https-enabled = {{ .Values.influxdb.config.http.https_enabled }}
      https-certificate = "{{ .Values.influxdb.config.http.https_certificate }}"
      https-private-key = "{{ .Values.influxdb.config.http.https_private_key }}"
      max-row-limit = {{ .Values.influxdb.config.http.max_row_limit | int64 }}
      max-connection-limit = {{ .Values.influxdb.config.http.max_connection_limit | int64 }}
      shared-secret = "{{ .Values.influxdb.config.http.shared_secret }}"
      realm = "{{ .Values.influxdb.config.http.realm }}"
      unix-socket-enabled = {{ .Values.influxdb.config.http.unix_socket_enabled }}
      bind-socket = "{{ .Values.influxdb.config.http.bind_socket }}"
    
    # TODO: allow multiple graphite listeners
    
    [[graphite]]
      enabled = {{ .Values.influxdb.config.graphite.enabled }}
      bind-address = ":{{ .Values.influxdb.config.graphite.bind_address }}"
      database = "{{ .Values.influxdb.config.graphite.database }}"
      retention-policy = "{{ .Values.influxdb.config.graphite.retention_policy }}"
      protocol = "{{ .Values.influxdb.config.graphite.protocol }}"
      batch-size = {{ .Values.influxdb.config.graphite.batch_size | int64 }}
      batch-pending = {{ .Values.influxdb.config.graphite.batch_pending | int64 }}
      batch-timeout = "{{ .Values.influxdb.config.graphite.batch_timeout }}"
      consistency-level = "{{ .Values.influxdb.config.graphite.consistency_level }}"
      separator = "{{ .Values.influxdb.config.graphite.separator }}"
      udp-read-buffer = {{ .Values.influxdb.config.graphite.udp_read_buffer | int64 }}
      {{- if .Values.influxdb.config.graphite.templates }}
      templates = [
        {{- range .Values.influxdb.config.graphite.templates }}
          {{ quote . }},
        {{- end }}
      ]
      {{- end }}
    
    # TODO: allow multiple collectd listeners with templates

    [[collectd]]
      enabled = {{ .Values.influxdb.config.collectd.enabled }}
      bind-address = ":{{ .Values.influxdb.config.collectd.bind_address }}"
      database = "{{ .Values.influxdb.config.collectd.database }}"
      retention-policy = "{{ .Values.influxdb.config.collectd.retention_policy }}"
      batch-size = {{ .Values.influxdb.config.collectd.batch_size | int64 }}
      batch-pending = {{ .Values.influxdb.config.collectd.batch_pending | int64 }}
      batch-timeout = "{{ .Values.influxdb.config.collectd.batch_timeout }}"
      read-buffer = {{ .Values.influxdb.config.collectd.read_buffer | int64 }}
      typesdb = "{{ .Values.influxdb.config.collectd.typesdb }}"
      security-level = "{{ .Values.influxdb.config.collectd.security_level }}"
      auth-file = "{{ .Values.influxdb.config.collectd.auth_file }}"
    
    # TODO: allow multiple opentsdb listeners with templates

    [[opentsdb]]
      enabled = {{ .Values.influxdb.config.opentsdb.enabled }}
      bind-address = ":{{ .Values.influxdb.config.opentsdb.bind_address }}"
      database = "{{ .Values.influxdb.config.opentsdb.database }}"
      retention-policy = "{{ .Values.influxdb.config.opentsdb.retention_policy }}"
      consistency-level = "{{ .Values.influxdb.config.opentsdb.consistency_level }}"
      tls-enabled = {{ .Values.influxdb.config.opentsdb.tls_enabled }}
      certificate = "{{ .Values.influxdb.config.opentsdb.certificate }}"
      batch-size = {{ .Values.influxdb.config.opentsdb.batch_size | int64 }}
      batch-pending = {{ .Values.influxdb.config.opentsdb.batch_pending | int64 }}
      batch-timeout = "{{ .Values.influxdb.config.opentsdb.batch_timeout }}"
      log-point-errors = {{ .Values.influxdb.config.opentsdb.log_point_errors }}
    
    # TODO: allow multiple udp listeners with templates

    [[udp]]
      enabled = {{ .Values.influxdb.config.udp.enabled }}
      bind-address = ":{{ .Values.influxdb.config.udp.bind_address }}"
      database = "{{ .Values.influxdb.config.udp.database }}"
      retention-policy = "{{ .Values.influxdb.config.udp.retention_policy }}"
      batch-size = {{ .Values.influxdb.config.udp.batch_size | int64 }}
      batch-pending = {{ .Values.influxdb.config.udp.batch_pending | int64 }}
      read-buffer = {{ .Values.influxdb.config.udp.read_buffer | int64 }}
      batch-timeout = "{{ .Values.influxdb.config.udp.batch_timeout }}"
      precision = "{{ .Values.influxdb.config.udp.precision }}"

    [continuous_queries]
      log-enabled = {{ .Values.influxdb.config.continuous_queries.log_enabled }}
      enabled = {{ .Values.influxdb.config.continuous_queries.enabled }}
      run-interval = "{{ .Values.influxdb.config.continuous_queries.run_interval }}"

    [logging]
      format =  "{{ .Values.influxdb.config.logging.format }}"
      level =  "{{ .Values.influxdb.config.logging.level }}"
      supress-logo = {{ .Values.influxdb.config.logging.supress_logo }}
